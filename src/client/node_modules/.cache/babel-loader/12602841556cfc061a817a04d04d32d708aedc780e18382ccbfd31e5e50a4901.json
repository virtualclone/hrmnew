{"ast":null,"code":"import { navigate, reloadPage } from '@/core/util/helper/navigation';\nimport { APIService } from '@/core/util/services/api.service';\nimport ReviewSummary from '../components/ReviewSummary';\nimport FinalEvaluation from '../components/FinalEvaluation';\nimport EvaluationForm from '../components/EvaluationForm';\nimport useForm from '@ohrm/core/util/composable/useForm';\nimport useReviewEvaluation from '@/orangehrmPerformancePlugin/util/composable/useReviewEvaluation';\nimport ReviewConfirmModal from '@/orangehrmPerformancePlugin/components/ReviewConfirmModal';\nconst reviewerModel = {\n  details: {\n    empNumber: null,\n    firstName: '',\n    lastName: '',\n    terminationId: null\n  },\n  jobTitle: '',\n  status: 1,\n  actions: new Map()\n};\nexport default {\n  name: 'SelfEvaluation',\n  components: {\n    'review-summary': ReviewSummary,\n    'final-evaluation': FinalEvaluation,\n    'evaluation-form': EvaluationForm,\n    'review-confirm-modal': ReviewConfirmModal\n  },\n  props: {\n    reviewId: {\n      type: Number,\n      required: true\n    },\n    status: {\n      type: Number,\n      required: true\n    },\n    reviewPeriodStart: {\n      type: String,\n      required: true\n    },\n    reviewPeriodEnd: {\n      type: String,\n      required: true\n    },\n    dueDate: {\n      type: String,\n      required: true\n    }\n  },\n  setup() {\n    const {\n      formRef,\n      invalid,\n      validate\n    } = useForm();\n    const http = new APIService(window.appGlobal.baseUrl, '');\n    const {\n      getAllKpis,\n      getEmployeeReview,\n      getSupervisorReview,\n      getFinalReview,\n      generateRules,\n      generateModel,\n      generateReviewerData,\n      generateAllowedActions,\n      generateEvaluationFormData,\n      finalizeReview,\n      saveEmployeeReview\n    } = useReviewEvaluation(http);\n    return {\n      http,\n      invalid,\n      formRef,\n      validate,\n      getAllKpis,\n      generateRules,\n      generateModel,\n      generateReviewerData,\n      generateAllowedActions,\n      generateEvaluationFormData,\n      getEmployeeReview,\n      getSupervisorReview,\n      getFinalReview,\n      finalizeReview,\n      saveEmployeeReview\n    };\n  },\n  data() {\n    return {\n      kpis: [],\n      rules: [],\n      employee: {\n        ...reviewerModel\n      },\n      employeeReview: {},\n      supervisor: {\n        ...reviewerModel\n      },\n      supervisorReview: {},\n      isLoading: false,\n      finalRating: null,\n      finalComment: null,\n      completedDate: null\n    };\n  },\n  computed: {\n    hasSaveAction() {\n      return this.employee.actions.has('save');\n    },\n    hasCompleteAction() {\n      return this.employee.actions.has('complete');\n    },\n    hasCancelAction() {\n      return !(this.status === 4 || this.employee?.status === 3);\n    },\n    hasActions() {\n      return this.hasSaveAction || this.hasCancelAction || this.hasCompleteAction;\n    }\n  },\n  beforeMount() {\n    this.isLoading = true;\n    this.getAllKpis(this.reviewId).then(response => {\n      const {\n        data\n      } = response.data;\n      this.kpis = [...data];\n      this.rules = this.generateRules(data);\n      this.employeeReview = this.generateModel(data);\n      this.supervisorReview = this.generateModel(data);\n      return this.getEmployeeReview(this.reviewId);\n    }).then(response => {\n      const {\n        data\n      } = response.data;\n      const {\n        meta\n      } = response.data;\n      this.employee = this.generateReviewerData(meta.reviewer);\n      this.employee.actions = this.generateAllowedActions(meta.allowedActions);\n      this.employeeReview = this.generateEvaluationFormData(data, meta.generalComment, this.employeeReview.kpis);\n      return this.getSupervisorReview(this.reviewId);\n    }).then(response => {\n      const {\n        data\n      } = response.data;\n      const {\n        meta\n      } = response.data;\n      this.supervisor = this.generateReviewerData(meta.reviewer);\n      this.supervisor.actions = this.generateAllowedActions(meta.allowedActions);\n      this.supervisorReview = this.generateEvaluationFormData(data, meta.generalComment, this.supervisorReview.kpis);\n      return this.status === 4 ? this.getFinalReview(this.reviewId) : {};\n    }).then(response => {\n      if (Object.keys(response).length !== 0) {\n        const {\n          data\n        } = response.data;\n        this.finalRating = data.finalRating;\n        this.finalComment = data.finalComment;\n        this.completedDate = data.completedDate;\n      }\n    }).finally(() => {\n      this.isLoading = false;\n    });\n  },\n  methods: {\n    onSubmit(complete = false) {\n      this.$nextTick().then(() => this.validate()).then(async () => {\n        if (this.invalid === true) return;\n        if (complete) {\n          this.$refs.confirmDialog.showDialog().then(confirmation => {\n            if (confirmation === 'ok') {\n              this.submitReview(true);\n            }\n          });\n        } else {\n          this.submitReview(false);\n        }\n      });\n    },\n    submitReview(complete = false) {\n      this.isLoading = true;\n      this.saveEmployeeReview(this.reviewId, complete, this.employeeReview).then(() => {\n        return this.$toast.saveSuccess();\n      }).finally(() => {\n        reloadPage();\n      });\n    },\n    onClickCancel() {\n      navigate('/performance/myPerformanceReview');\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}